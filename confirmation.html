<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Confirmation & Ticket Details (Group B)</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --theme: #762922;
      --panel-bg: #fff;
      --border: #ddd;
      --text-primary: #333;
      --text-secondary: #666;
    }
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--panel-bg);
      color: var(--text-primary);
    }
    .container {
      width: 90%;
      max-width: 600px;
      margin: 2rem auto;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    header {
      background: var(--theme);
      color: #fff;
      padding: 1rem;
      font-size: 1.25rem;
      font-weight: 500;
      text-align: center;
    }
    .details {
      padding: 1.5rem;
    }
    .details p {
      margin: 0.75rem 0;
      font-size: 1rem;
    }
    .details p span.label {
      display: inline-block;
      width: 120px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .details p span.value {
      color: var(--text-primary);
      font-weight: 400;
    }
    .notice {
      background: #f8f9fa;
      padding: 1rem;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
      border-top: 1px solid var(--border);
    }
    .actions {
      text-align: center;
      padding: 1rem;
      background: var(--panel-bg);
    }
    .actions button {
      padding: 0.75rem 1.5rem;
      background: var(--theme);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>Confirmation & Ticket Details</header>
    <div class="details">
      <p><span class="label">Concert:</span>
         <span class="value">2025 ＆TEAM CONCERT TOUR ‘AWAKEN THE BLOODLINE’</span>
      </p>
      <p><span class="label">Date &amp; Session:</span>
         <span class="value" id="date-session"></span>
      </p>
      <p><span class="label">Buyer:</span>
         <span class="value" id="buyer-name"></span>
      </p>
      <p><span class="label">Payment:</span>
         <span class="value" id="payment-method"></span>
      </p>
      <p><span class="label">Total Time:</span>
         <span class="value" id="total-time">0s</span>
      </p>
    </div>
    <div class="notice">
      📸 Please take a screenshot of the test result page, and send it to the researcher.<br>
      You can view the test result page by clicking “Finish & View Results” button. <br> <br>
      📸 테스트 결과 페이지를 스크린캡쳐하여 연구인에게 전송해주시길 바랍니다. <br>
      테스트 결과 페이지는 하단의 “Finish & View Results” 버튼을 누르면 볼 수 있습니다. <br> <br>
      📸 テスト結果のページをスクリーンショットして、研究者に送ってください。<br>「
      終了して結果を表示」ボタンをクリックすると、テスト結果のページを見ることができます。
    </div>
    <div class="actions">
      <button id="finish-btn">Finish & View Results</button>
    </div>
  </div>

  <script>
    // Populate fields from sessionStorage/localStorage
    document.getElementById('date-session').textContent =
      sessionStorage.getItem('concertDate') + ' / ' +
      sessionStorage.getItem('concertSession');
    document.getElementById('buyer-name').textContent =
      localStorage.getItem('buyerIdB') || 'N/A';
    document.getElementById('payment-method').textContent =
      sessionStorage.getItem('paymentMethod') || 'N/A';

    // Compute elapsed time (from startTime stored in sessionStorage)
    const start = parseInt(sessionStorage.getItem('startTime'), 10);
    const elapsed = start
      ? Math.floor((Date.now() - start) / 1000)
      : 0;
    document.getElementById('total-time').textContent = elapsed + 's';

    // Save to groupBResults and redirect to result.html
    function saveGroupBResult(userId, timeTaken, success) {
      const STORAGE_KEY = 'groupBResults';
      let arr;
      try {
        arr = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        if (!Array.isArray(arr)) arr = [];
      } catch {
        arr = [];
      }
      arr.push({
        userId,
        time: timeTaken,
        attempts: 1,
        success,
        timestamp: new Date().toISOString()
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    document.getElementById('finish-btn').addEventListener('click', () => {
      const userId  = localStorage.getItem('buyerIdB') || '';
      const time    = parseInt(document.getElementById('total-time').textContent, 10) || 0;
      const success = localStorage.getItem('captchaSuccess') === 'true';

      if (!userId) {
        alert('Buyer ID not found.');
        return;
      }
      saveGroupBResult(userId, time, success);

      // Redirect to result page
      window.location.href = 'result.html';
    });
  </script>
</body>
</html>
